# ============================================================================
# Package and Publish Release
# ============================================================================
# Creates a .zip release package when a version tag is pushed.
#
# Usage:
#   git tag v1.0.0
#   git push origin v1.0.0
#
# Or trigger manually from the Actions tab and enter a version tag.
#
# The release includes:
#   - src/ (Python scripts)
#   - powerbi/ (Power BI setup guide + generated .pbit template)
#   - data/sample.csv (sample data for previewing)
#   - requirements.txt, .env.example, README.md
#   - .github/workflows/ (automation workflows)
# ============================================================================

name: Publish Release

on:
  push:
    tags:
      - "v*"

  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. v1.0.0)"
        required: true

permissions:
  contents: write

env:
  RELEASE_NAME: "pr-dashboard"

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "tag=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Create release package
        run: |
          VERSION="${{ steps.version.outputs.tag }}"
          ARCHIVE="${RELEASE_NAME}-${VERSION}.zip"

          zip -r "$ARCHIVE" \
            src/ \
            powerbi/ \
            data/sample.csv \
            .github/workflows/ \
            requirements.txt \
            .env.example \
            README.md \
            -x "*.pyc" "__pycache__/*" ".venv/*" "data/pull_requests.csv" "data/snapshots/*"

          echo "archive=$ARCHIVE" >> $GITHUB_ENV
          echo "Created: $ARCHIVE ($(du -h "$ARCHIVE" | cut -f1))"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "PR Dashboard ${{ steps.version.outputs.tag }}"
          body: |
            ## PR Dashboard ${{ steps.version.outputs.tag }}

            Download the `.zip` below, extract, and follow the [README](https://github.com/${{ github.repository }}#quick-start) to get started.

            ### What's included
            - `src/fetch_pr_data.py` — Data collection script (GraphQL search API)
            - `src/upload_data.py` — Cloud storage upload/download (Azure Blob, S3)
            - `powerbi/SETUP_GUIDE.md` — Power BI dashboard build guide
            - `data/sample.csv` — Sample data for previewing
            - `.github/workflows/` — Automated refresh workflows
            - `requirements.txt`, `.env.example`, `README.md`
          files: ${{ env.archive }}
          generate_release_notes: true
          draft: false
          prerelease: false
